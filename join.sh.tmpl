#!/bin/bash

set +e  # NICHT bei Fehlern abbrechen!

echo "üîß [INFO] Worker Nodes joinen"
JOIN=$(sudo microk8s add-node --token-ttl 3600 | grep worker | tail -1)

# Funktion: Warten auf SSH-Verbindung
wait_for_ssh() {
    NODE=$1
    MAX_RETRIES=60
    SLEEP_SECONDS=10

    echo "- ‚è≥ [INFO] Warten auf SSH-Verbindung zu $NODE..."

    for ((i=1; i<=MAX_RETRIES; i++)); do
        ssh -o BatchMode=yes -o ConnectTimeout=5 $NODE "echo 'SSH OK'" >/dev/null 2>&1
        if [ $? -eq 0 ]; then
            echo "- ‚úÖ [INFO] SSH-Verbindung zu $NODE verf√ºgbar"
            return 0
        fi
        echo "- ‚åõ [INFO] SSH-Verbindung zu $NODE noch nicht m√∂glich ($i/$MAX_RETRIES)..."
        sleep $SLEEP_SECONDS
    done

    echo "- ‚ùå [ERROR] SSH-Verbindung zu $NODE konnte nicht aufgebaut werden"
    return 1
}

# Funktion: Worker joinen mit Retry
join_worker() {
    NODE=$1
    MAX_RETRIES=30
    SLEEP_SECONDS=10

    echo "- ‚û°Ô∏è [INFO] Joinversuch f√ºr $NODE starten"

    for ((i=1; i<=MAX_RETRIES; i++)); do
        ssh $NODE -- sudo $JOIN
        if [ $? -eq 0 ]; then
            echo "- ‚úÖ [INFO] Worker $NODE erfolgreich gejoint"
            return 0
        fi
        echo "- ‚ö†Ô∏è [ERROR] Worker $NODE Join fehlgeschlagen (Versuch $i/$MAX_RETRIES), neuer Versuch in $SLEEP_SECONDS ..."
        sleep $SLEEP_SECONDS
    done

    echo "‚ùå [FATAL] Worker $NODE konnte nicht gejoined werden"
    return 1
}

# Worker 1
wait_for_ssh ${worker1} && join_worker ${worker1}

# Worker 2
wait_for_ssh ${worker2} && join_worker ${worker2}

# Mounts danach
echo "- üîß [INFO] Worker Nodes /data mounten"

echo "- ‚û°Ô∏è [INFO] Worker 1 /data mounten"
ssh ${worker1} "sudo mkdir -p /data; sudo mount -t nfs ${controlplane}:/data /data" || echo "‚ö†Ô∏è [ERROR] Worker 1 /data mounten fehlgeschlagen"

echo "- ‚û°Ô∏è [INFO] Worker 2 /data mounten"
ssh ${worker2} "sudo mkdir -p /data; sudo mount -t nfs ${controlplane}:/data /data" || echo "‚ö†Ô∏è [ERROR] Worker 2 /data mounten fehlgeschlagen"

echo "- üîß [INFO] Worker Nodes /var/snap/microk8s/common/default-storage mounten"

echo "- ‚û°Ô∏è [INFO] Worker 1 /default-storage mounten"
ssh ${worker1} "sudo mount -t nfs ${controlplane}:/var/snap/microk8s/common/default-storage /var/snap/microk8s/common/default-storage" || echo "‚ö†Ô∏è [ERROR] Worker 1 /default-storage mounten fehlgeschlagen"

echo "- ‚û°Ô∏è [INFO] Worker 2 /default-storage mounten"
ssh ${worker2} "sudo mount -t nfs ${controlplane}:/var/snap/microk8s/common/default-storage /var/snap/microk8s/common/default-storage" || echo "‚ö†Ô∏è [ERROR] Worker 2 /default-storage mounten fehlgeschlagen"

echo "‚úÖ [INFO] Worker Nodes joinen abgeschlossen (Fehler ggf. oben pr√ºfen)"

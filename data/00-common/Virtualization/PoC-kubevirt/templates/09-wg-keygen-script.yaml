apiVersion: v1
kind: ConfigMap
metadata:
  name: wg-keygen-script
data:
  keygen.sh: |-
    #!/bin/sh
    set -e

    echo "[KEYGEN] starting"
    apk add --no-cache wireguard-tools kubectl jq curl

    USERDATA_URL="{{ .Values.vm.userdata }}"
    COUNT="{{ .Values.vm.count }}"

    echo "[KEYGEN] waiting for gateway public key"
    until kubectl get secret wg-gateway-pub >/dev/null 2>&1; do
      sleep 2
    done

    GW_PUB="$(kubectl get secret wg-gateway-pub -o json | jq -r '.data.publickey | @base64d')"

    i=0
    while [ "$i" -lt "$COUNT" ]; do
      echo "[KEYGEN] processing vm-$i"

      ### 1️⃣ cloud-init von RAW URL holen
      HTTP_CODE="$(curl -sSL -w '%{http_code}' -o /tmp/userdata.yaml "$USERDATA_URL" || echo 000)"
      
      if [ "$HTTP_CODE" != "200" ]; then
        echo "[KEYGEN][WARN] cloud-init download failed (HTTP $HTTP_CODE)"
        echo "[KEYGEN][WARN] vm-$i will be created WITHOUT cloud-init"
        rm -f /tmp/userdata.yaml
      else

        ### 2️⃣ WireGuard Keys + Config erzeugen
        umask 077
        PRIV="$(wg genkey)"
        PUB="$(printf "%s" "$PRIV" | wg pubkey)"
        IP="$((i+10))"
  
        cat >> /tmp/userdata.yaml <<EOF
    write_files:
      - path: /etc/wireguard/vm-$i.conf
        permissions: "0600"
        owner: root:root
        content: |
          [Interface]
          PrivateKey = $PRIV
          Address = 10.10.0.$IP/32            
    
          [Peer]
          PublicKey = $GW_PUB
          Endpoint = wg-gateway:51820
          AllowedIPs = 10.10.0.0/24      
          PersistentKeepalive = 25
    EOF

        kubectl create secret generic "vm-$i" \
          --from-file=userData=/tmp/userdata.yaml \
          --from-literal=publickey="$PUB" \
          --dry-run=client -o yaml | kubectl apply -f -
      fi

      i=$((i+1))
    done

    echo "[KEYGEN] done"
